<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务数量统计</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #409eff;
            background-color: #f8f9fa;
        }
        .upload-area.active {
            border-color: #67c23a;
            background-color: #f0f9eb;
        }
        #fileInput {
            display: none;
        }
        .upload-text {
            color: #666;
            font-size: 16px;
        }
        .result-area {
            display: none;
            margin-top: 30px;
        }
        .stat-item {
            padding: 15px;
            margin: 10px 0;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-item span:first-child {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        .stat-item span:last-child {
            font-size: 20px;
            color: #409eff;
            font-weight: bold;
        }
        .total {
            background-color: #e8f4ff;
            border-left: 4px solid #409eff;
        }
        .error-msg {
            color: #f56c6c;
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>服务数量统计</h1>
        
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <div class="upload-text">
                <p>点击或拖拽Excel文件到此处上传</p>
                <p style="margin-top: 10px; font-size: 14px; color: #999;">支持 .xlsx / .xls 格式</p>
            </div>
        </div>
        
        <div class="error-msg" id="errorMsg"></div>
        
        <div class="result-area" id="resultArea">
            <h2 style="margin-bottom: 20px; color: #333;">统计结果</h2>
            <div class="stat-item" id="servicePlatform">
                <span>服务平台</span>
                <span id="servicePlatformCount">0</span>
            </div>
            <div class="stat-item" id="certHelper">
                <span>证书助手</span>
                <span id="certHelperCount">0</span>
            </div>
            <div class="stat-item" id="relatedService">
                <span>相关服务</span>
                <span id="relatedServiceCount">0</span>
            </div>
            <div class="stat-item" id="eTax">
                <span>电子税务局</span>
                <span id="eTaxCount">0</span>
            </div>
            <div class="stat-item" id="personalTax">
                <span>个所税</span>
                <span id="personalTaxCount">0</span>
            </div>
            <div class="stat-item" id="fund">
                <span>公积金</span>
                <span id="fundCount">0</span>
            </div>
            <div class="stat-item" id="socialSecurity">
                <span>社保</span>
                <span id="socialSecurityCount">0</span>
            </div>
            <div class="stat-item" id="taxSoftware">
                <span>税控软件</span>
                <span id="taxSoftwareCount">0</span>
            </div>
            <div class="stat-item total">
                <span>总计</span>
                <span id="totalCount">0</span>
            </div>
        </div>
    </div>

    <!-- 引入SheetJS库 -->
    <script src="./js/xlsx.full.min.js"></script>
    <script>
        // 定义分类规则（已更新电子税务局关键词）
        const categoryRules = {
            服务平台: [
                "服务平台-非专区功能",
                "服务平台-多用户版本",
                "服务平台-财税专区",
                "服务平台-工商专区"
            ],
            证书助手: [
                "国信CA证书",
                "行助手"
            ],
            相关服务_专属: [ // 单独区分相关服务的专属关键词
                "相关服务",
                "江南银行合作软件",
                "企业QQ消单",
                "微信咨询",
                "智能客服咨询",
                "晨会内容"
            ],
            电子税务局: [
                "全国统一规范电子税务局", // 修正关键词
                "单位社保费管理客户端",
                "出口退税专区"
            ],
            个所税: [
                "自然人税收管理系统扣缴客户端"
            ],
            公积金: [
                "服务平台-公积金专区"
            ],
            社保: [
                "服务平台—人社专区【新】"
            ],
            税控软件: [
                "税控开票软件"
            ]
        };

        // 获取DOM元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const resultArea = document.getElementById('resultArea');
        const errorMsg = document.getElementById('errorMsg');

        // 上传区域点击事件
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // 文件选择事件
        fileInput.addEventListener('change', handleFileUpload);

        // 拖拽事件处理
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('active');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('active');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('active');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });

        // 处理文件上传
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;

            // 检查文件格式
            const fileExt = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls'].includes(fileExt)) {
                showError('请上传Excel格式的文件（.xlsx 或 .xls）');
                return;
            }

            // 读取文件
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // 解析Excel文件
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 转换为JSON格式
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        showError('表格中没有数据，请检查文件内容');
                        return;
                    }

                    // 检查是否有"问题描述"列
                    const hasQuestionColumn = jsonData.some(item => 
                        Object.keys(item).some(key => 
                            key.includes('问题描述') || key === '问题描述'
                        )
                    );

                    if (!hasQuestionColumn) {
                        showError('表格中未找到"问题描述"列，请检查表格结构');
                        return;
                    }

                    // 统计数据
                    const stats = calculateStats(jsonData);
                    
                    // 展示结果
                    displayResults(stats);
                    
                } catch (err) {
                    showError('文件解析失败：' + err.message);
                    console.error(err);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // 统计数据（核心更新逻辑）
        function calculateStats(data) {
            // 初始化统计结果
            const stats = {
                服务平台: 0,
                证书助手: 0,
                相关服务: 0,
                电子税务局: 0,
                个所税: 0,
                公积金: 0,
                社保: 0,
                税控软件: 0,
                总计: 0
            };

            // 遍历每一行数据
            data.forEach(row => {
                // 找到问题描述列的值
                let questionDesc = '';
                for (const key in row) {
                    if (key.includes('问题描述') || key === '问题描述') {
                        questionDesc = (row[key] || '').toString().trim();
                        break;
                    }
                }

                if (!questionDesc) return; // 空值跳过

                let matched = false;

                // 1. 先匹配除相关服务外的专属分类
                const categories = [
                    { name: '服务平台', rules: categoryRules.服务平台 },
                    { name: '证书助手', rules: categoryRules.证书助手 },
                    { name: '电子税务局', rules: categoryRules.电子税务局 },
                    { name: '个所税', rules: categoryRules.个所税 },
                    { name: '公积金', rules: categoryRules.公积金 },
                    { name: '社保', rules: categoryRules.社保 },
                    { name: '税控软件', rules: categoryRules.税控软件 }
                ];

                // 匹配专属分类
                for (const category of categories) {
                    for (const prefix of category.rules) {
                        if (questionDesc.startsWith(prefix)) {
                            stats[category.name]++;
                            stats.总计++;
                            matched = true;
                            break;
                        }
                    }
                    if (matched) break;
                }

                // 2. 如果未匹配到专属分类，检查是否匹配相关服务专属关键词，或直接计入相关服务
                if (!matched) {
                    // 检查是否匹配相关服务专属关键词
                    const isRelatedServiceSpecial = categoryRules.相关服务_专属.some(prefix => 
                        questionDesc.startsWith(prefix)
                    );
                    
                    // 无论是否匹配相关服务专属关键词，都计入相关服务（包括其他未匹配内容）
                    stats.相关服务++;
                    stats.总计++;
                }
            });

            return stats;
        }

        // 展示统计结果
        function displayResults(stats) {
            // 隐藏错误信息
            errorMsg.style.display = 'none';
            
            // 更新统计数值
            document.getElementById('servicePlatformCount').textContent = stats.服务平台;
            document.getElementById('certHelperCount').textContent = stats.证书助手;
            document.getElementById('relatedServiceCount').textContent = stats.相关服务;
            document.getElementById('eTaxCount').textContent = stats.电子税务局;
            document.getElementById('personalTaxCount').textContent = stats.个所税;
            document.getElementById('fundCount').textContent = stats.公积金;
            document.getElementById('socialSecurityCount').textContent = stats.社保;
            document.getElementById('taxSoftwareCount').textContent = stats.税控软件;
            document.getElementById('totalCount').textContent = stats.总计;

            // 显示结果区域
            resultArea.style.display = 'block';
        }

        // 显示错误信息
        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            resultArea.style.display = 'none';
        }
    </script>
</body>
</html>